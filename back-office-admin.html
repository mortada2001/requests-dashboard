<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back Office Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Modern Dashboard Styles */
        .dashboard-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card .icon {
            background-color: #f3f4f6;
            border-radius: 50%;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
        }

        .dashboard-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .dashboard-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .dashboard-card .description {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .status-ready { background-color: #dcfce7; color: #166534; }
        .status-coffee-break { background-color: #ffedd5; color: #9a3412; }
        .status-lunch-break { background-color: #fee2e2; color: #b91c1c; }
        .status-offline { background-color: #f3f4f6; color: #6b7280; }

        .employee-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Add style for priority highlighting */
        .employee-card[data-priority="1"] {
            border-left: 4px solid #ef4444; /* Red for lunch break */
        }
        
        .employee-card[data-priority="2"] {
            border-left: 4px solid #f97316; /* Orange for coffee break */
        }
        
        .employee-card[data-priority="3"] {
            border-left: 4px solid #22c55e; /* Green for ready */
        }
        
        /* Table row priority highlighting */
        #employee-table-body tr[data-priority="1"] {
            border-left: 4px solid #ef4444;
        }
        
        #employee-table-body tr[data-priority="2"] {
            border-left: 4px solid #f97316;
        }
        
        #employee-table-body tr[data-priority="3"] {
            border-left: 4px solid #22c55e;
        }
        
        /* Add subtle fade-in animation for cards and rows */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .employee-card, #employee-table-body tr {
            animation: fadeIn 0.3s ease forwards;
        }

        .status-dropdown {
            position: relative;
            display: inline-block;
        }

        .status-dropdown-content {
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            z-index: 1;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .status-dropdown.active .status-dropdown-content {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .status-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .status-option:hover {
            background-color: #f3f4f6;
        }

        .break-timer {
            width: 100%;
            height: 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .break-timer-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .coffee-progress, .lunch-progress, .login-progress {
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Table styles to match cards */
        #employee-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }

        #employee-table thead th {
            background-color: #f9fafb;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        #employee-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        #employee-table tbody tr:last-child {
            border-bottom: none;
        }

        #employee-table tbody tr:hover {
            background-color: #f0f9ff;
        }

        #employee-table tbody tr td {
            padding: 1rem 1.5rem;
            vertical-align: middle;
        }

        /* Style for progress bars specifically in the table */
        #employee-table .break-timer {
            height: 6px;
            width: 100%;
            background-color: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
        }

        #employee-table .break-timer-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Status history modal styles */
        .status-history-modal {
            background: white;
            border-radius: 1rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .status-history-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .status-history-table tr:hover {
            background-color: #f8fafc;
        }

        .status-history-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .status-history-table tr:last-child td {
            border-bottom: none;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .status-ready { background-color: #dcfce7; color: #166534; }
        .status-coffee-break { background-color: #ffedd5; color: #9a3412; }
        .status-lunch-break { background-color: #fee2e2; color: #b91c1c; }
        .status-task { background-color: #e0e7ff; color: #3730a3; }
        .status-offline { background-color: #f3f4f6; color: #6b7280; }

        #status-history-modal {
            overscroll-behavior: contain;
        }

        .status-history-modal > div:nth-child(2) {
            overflow-y: auto;
            max-height: calc(90vh - 4rem);
        }

        .view-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-switcher button {
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f3f4f6;
            color: #6b7280;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }

        .view-switcher button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .view-switcher button:hover:not(.active) {
            background-color: #e5e7eb;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-filter {
            min-width: 140px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background-color: white;
            font-size: 0.875rem;
            color: #374151;
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #f3f4f6;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background-color: #e5e7eb;
        }

        .refresh-btn i {
            font-size: 0.875rem;
        }

        .progress-bar {
            height: 0.5rem;
            border-radius: 9999px;
            background-color: #f3f4f6;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .ticket-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .ticket-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .ticket-card.overdue {
            border-left: 4px solid #ef4444;
        }

        .ticket-card.approaching {
            border-left: 4px solid #f59e0b;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
        }

        .nav-link {
            position: relative;
            padding: 0.5rem 1rem;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: #3b82f6;
        }

        .nav-link.active {
            color: #3b82f6;
            font-weight: 500;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1rem;
            right: 1rem;
            height: 2px;
            background-color: #3b82f6;
            border-radius: 9999px;
        }

        /* Improved loading bar styles */
        .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container .icon {
            flex-shrink: 0;
            width: 1rem;
            display: flex;
            justify-content: center;
        }

        .progress-container .progress-bar {
            flex-grow: 1;
            height: 6px;
            background-color: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-container .time-display {
            flex-shrink: 0;
            font-size: 0.75rem;
            color: #6b7280;
            min-width: 3.5rem;
            text-align: right;
        }

        .no-transition {
            transition: none !important;
        }
        
        /* Progress bar styles */
        .break-timer {
            width: 100%;
            height: 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        [class*="coffee-progress-"],
        [class*="lunch-progress-"],
        [class*="login-progress-"] {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
            position: relative;
            /* Remove min-width to prevent showing when usage is 0 */
        }
        
        /* Hide progress bars completely when width is 0 */
        [class*="coffee-progress-"][style="width: 0%;"],
        [class*="lunch-progress-"][style="width: 0%;"],
        [class*="login-progress-"][style="width: 0%;"] {
            display: none;
        }
        
        [class*="coffee-progress-"] {
            background-color: #f97316 !important; /* Orange */
        }
        
        [class*="lunch-progress-"] {
            background-color: #ef4444 !important; /* Red */
        }
        
        [class*="login-progress-"] {
            background-color: #3b82f6 !important; /* Blue */
        }
        
        /* Add shine effect to make progress bars more noticeable */
        [class*="coffee-progress-"]::after,
        [class*="lunch-progress-"]::after,
        [class*="login-progress-"]::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Ticket search and pagination styles */
        #ticket-search {
            min-width: 200px;
            transition: all 0.2s ease;
        }

        #ticket-search:focus {
            min-width: 240px;
        }

        .pagination-btn {
            transition: all 0.2s ease;
        }

        .pagination-btn:not(:disabled):hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
        }

        /* Improved ticket card styles */
        .ticket-card {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .ticket-card.overdue {
            border-left: 4px solid #ef4444;
        }

        .ticket-card.approaching {
            border-left: 4px solid #f59e0b;
        }

        /* Style for the assigned_to info in ticket cards */
        .ticket-assigned {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .ticket-assigned.bg-green-50 {
            border-color: #d1fae5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .ticket-assigned.bg-gray-50 {
            border-color: #f3f4f6;
            opacity: 0.9;
        }

        .ticket-assigned:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Ticket badge styles */
        .ticket-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-new {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-in-progress {
            background-color: #dcfce7;
            color: #166534;
        }

        .badge-closed {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .badge-overdue {
            background-color: #fee2e2;
            color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] w-[350px] pointer-events-auto"></div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                        <h1 class="text-xl font-bold text-gray-800">Back Office Admin</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user text-gray-400"></i>
                            <span id="user-name" class="text-gray-600 font-medium"></span>
                        </div>
                        <button id="logout" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="icon">
                            <i class="fas fa-users text-indigo-600"></i>
                        </div>
                        <div>
                            <h3>Active Employees</h3>
                            <p id="active-employees">0/0</p>
                            <span class="description">Currently active</span>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="icon">
                            <i class="fas fa-ticket-alt text-emerald-600"></i>
                        </div>
                        <div>
                            <h3>New Tickets</h3>
                            <p id="new-tickets">0</p>
                            <span class="description">Tickets awaiting action</span>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="icon">
                            <i class="fas fa-coffee text-amber-600"></i>
                        </div>
                        <div>
                            <h3>Coffee Break</h3>
                            <p id="coffee-break">0</p>
                            <span class="description">Employees on coffee break</span>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="icon">
                            <i class="fas fa-utensils text-red-600"></i>
                        </div>
                        <div>
                            <h3>Lunch Break</h3>
                            <p id="lunch-break">0</p>
                            <span class="description">Employees on lunch break</span>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="icon">
                            <i class="fas fa-star text-blue-600"></i>
                        </div>
                        <div>
                            <h3>Contractor Feedback</h3>
                            <p id="contractor-feedback">0</p>
                            <span class="description">Feedback received</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-4 px-4 py-2">
                        <button class="nav-link active" data-tab="employees">
                            <i class="fas fa-users mr-2"></i>
                            Employee Status
                        </button>
                        <button class="nav-link" data-tab="tickets">
                            <i class="fas fa-ticket-alt mr-2"></i>
                            Ticket Monitoring
                        </button>
                        <button class="nav-link" data-tab="analytics">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Analytics
                        </button>
                    </nav>
                </div>

                <!-- Employees Tab -->
                <div id="employees-tab" class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">Employee Status</h2>
                        <div class="header-controls">
                            <div class="view-switcher">
                                <button id="card-view" class="active">
                                    <i class="fas fa-th-large"></i>
                                    Cards
                                </button>
                                <button id="table-view">
                                    <i class="fas fa-table"></i>
                                    Table
                                </button>
                            </div>
                            <select id="employee-status-filter" class="status-filter">
                                <option value="all">All Statuses</option>
                                <option value="ready">Ready</option>
                                <option value="coffee-break">Coffee Break</option>
                                <option value="lunch-break">Lunch Break</option>
                                <option value="offline">Offline</option>
                            </select>
                            <select id="employee-sort-order" class="status-filter">
                                <option value="break">Sort by Break</option>
                                <option value="ready">Sort by Ready</option>
                                <option value="alpha">Sort by Name A-Z</option>
                            </select>
                            <button id="refresh-employees" class="refresh-btn">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <div id="employee-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Employee cards will be loaded here -->
                    </div>

                    <div id="employee-table" class="hidden overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Break Time Left</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time in Status</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Today's Stats</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employee-table-body">
                                <!-- Table rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tickets Tab -->
                <div id="tickets-tab" class="p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">Ticket Monitoring</h2>
                        <div class="flex space-x-3">
                            <input type="text" id="ticket-search" placeholder="Search by ticket ID" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <select id="ticket-status-filter" class="status-filter">
                                <option value="all">All Statuses</option>
                                <option value="new">New</option>
                                <option value="in-progress">In Progress</option>
                                <option value="closed">Closed</option>
                                <option value="overdue">Overdue</option>
                                <option value="approaching">Approaching SLA</option>
                            </select>
                            <select id="ticket-sort" class="status-filter">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="priority">By Priority</option>
                            </select>
                            <button id="refresh-tickets" class="refresh-btn">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tickets Statistics -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex items-center space-x-2">
                                <div class="bg-blue-100 p-2 rounded-full">
                                    <i class="fas fa-ticket-alt text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">Total Tickets</h3>
                                    <p id="total-tickets-count" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex items-center space-x-2">
                                <div class="bg-blue-100 p-2 rounded-full">
                                    <i class="fas fa-inbox text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">New</h3>
                                    <p id="new-tickets-count" class="text-2xl font-bold text-blue-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex items-center space-x-2">
                                <div class="bg-green-100 p-2 rounded-full">
                                    <i class="fas fa-spinner text-green-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">In Progress</h3>
                                    <p id="in-progress-tickets-count" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex items-center space-x-2">
                                <div class="bg-gray-100 p-2 rounded-full">
                                    <i class="fas fa-check-circle text-gray-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">Closed</h3>
                                    <p id="closed-tickets-count" class="text-2xl font-bold text-gray-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex items-center space-x-2">
                                <div class="bg-red-100 p-2 rounded-full">
                                    <i class="fas fa-exclamation-circle text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">Overdue</h3>
                                    <p id="overdue-tickets-count" class="text-2xl font-bold text-red-600">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tickets-container" class="space-y-4">
                        <!-- Tickets will be loaded here -->
                    </div>

                    <!-- Pagination Controls -->
                    <div class="mt-6 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="tickets-pagination-info">
                            Showing <span id="tickets-showing">0</span> of <span id="tickets-total">0</span> tickets
                        </div>
                        <div class="flex space-x-2">
                            <button id="tickets-prev-page" class="pagination-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left mr-1"></i> Previous
                            </button>
                            <button id="tickets-next-page" class="pagination-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                Next <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div id="analytics-tab" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="dashboard-card">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Status Distribution</h3>
                            <div class="chart-container">
                                <canvas id="status-distribution-chart"></canvas>
                            </div>
                        </div>
                        <div class="dashboard-card">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Ticket Volume</h3>
                            <div class="chart-container">
                                <canvas id="ticket-volume-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Employee Details Modal -->
    <div id="employee-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Employee Details</h3>
                <button class="text-gray-400 hover:text-gray-500" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="employee-details-content">
                <!-- Employee details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Status History Modal Template -->
    <div id="status-history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-hidden">
        <div class="status-history-modal">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Status History</h3>
                <button onclick="closeStatusHistory()" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="px-6 pb-4">
                <div class="mb-4">
                    <input type="date" id="history-date" class="form-input w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" onchange="refreshStatusHistory()">
                </div>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3">Time Summary</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                            <p class="text-sm text-gray-600">Ready Time:</p>
                            <p id="ready-time" class="font-medium text-gray-800">0 minutes</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                            <p class="text-sm text-gray-600">Task Time:</p>
                            <p id="task-time" class="font-medium text-gray-800">0 minutes</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                            <p class="text-sm text-gray-600">Coffee Break:</p>
                            <p id="coffee-time" class="font-medium text-gray-800">0 minutes</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                            <p class="text-sm text-gray-600">Lunch Break:</p>
                            <p id="lunch-time" class="font-medium text-gray-800">0 minutes</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600">Total Active Time:</p>
                        <p id="total-time" class="font-medium text-gray-800 text-lg">0 minutes</p>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="status-history-table w-full">
                        <thead>
                            <tr>
                                <th class="bg-gray-50 text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Status</th>
                                <th class="bg-gray-50 text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Start Time</th>
                                <th class="bg-gray-50 text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">End Time</th>
                                <th class="bg-gray-50 text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="status-history-content">
                            <!-- Status history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://pdcssepqmgzpkayzfqta.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkY3NzZXBxbWd6cGtheXpmcXRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA4MzczMjksImV4cCI6MjA1NjQxMzMyOX0.NqN7b7itdA8Tz0sG4fzSI4Y19P5syYFWnmKwANbH1IY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let statusCharts = {};
        let volumeChart = null;
        let currentHistoryEmail = null;

        // Load statistics
        async function loadStatistics() {
            try {
                // Get total and active employees count
                const { data: employees } = await supabase
                    .from('requests_users')
                    .select('*')
                    .eq('role', 'back-office');

                if (!employees) {
                    throw new Error('No employee data received');
                }

                const totalEmployees = employees.length;
                const activeEmployees = employees.filter(emp => 
                    emp.status === 'ready' || 
                    emp.status === 'task' || 
                    emp.status === 'coffee-break' || 
                    emp.status === 'lunch-break'
                ).length;

                document.getElementById('active-employees').textContent = `${activeEmployees}/${totalEmployees}`;

                // Get ticket counts
                const { data: tickets } = await supabase
                    .from('tickets')
                    .select('*');

                const newTickets = tickets?.filter(t => t.status === 'new').length || 0;
                const inProgressTickets = tickets?.filter(t => t.status === 'in-progress').length || 0;
                const closedTickets = tickets?.filter(t => t.status === 'closed').length || 0;
                const overdueTickets = tickets?.filter(t => isOverdue(t)).length || 0;

                // Update both ticket count displays
                document.getElementById('new-tickets').textContent = newTickets;
                document.getElementById('new-tickets-count').textContent = newTickets;
                document.getElementById('in-progress-tickets-count').textContent = inProgressTickets;
                document.getElementById('closed-tickets-count').textContent = closedTickets;
                document.getElementById('overdue-tickets-count').textContent = overdueTickets;
                document.getElementById('total-tickets-count').textContent = tickets?.length || 0;

                // Get employees on coffee and lunch breaks
                const coffeeBreak = employees.filter(emp => emp.status === 'coffee-break').length;
                const lunchBreak = employees.filter(emp => emp.status === 'lunch-break').length;

                document.getElementById('coffee-break').textContent = coffeeBreak;
                document.getElementById('lunch-break').textContent = lunchBreak;

                // Update contractor feedback (placeholder)
                document.getElementById('contractor-feedback').textContent = '0';

                // Update charts if they exist
                if (statusCharts && volumeChart) {
                    updateCharts();
                }

            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('Failed to load statistics', 'error');
            }
        }

        // Set up realtime subscriptions
        function setupRealTimeSubscriptions() {
            // Subscribe to employee status changes
            supabase
                .channel('employee-status')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'requests_users' }, payload => {
                    if (payload.new.role === 'back-office') {
                        loadEmployees();
                        updateCharts();
                    }
                })
                .subscribe();

            // Subscribe to ticket changes
            supabase
                .channel('tickets')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, payload => {
                    loadTickets();
                    loadStatistics();
                    updateCharts();
                })
                .subscribe();
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check session
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error || !session) {
                    window.location.href = 'login.html';
                    return;
                }

                // Get user data
                const { data: userData, error: userError } = await supabase
                    .from('requests_users')
                    .select('*')
                    .eq('email', session.user.email)
                    .single();

                if (userError || userData.role !== 'admin-back-office') {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = { ...session.user, ...userData };
                document.getElementById('user-name').textContent = currentUser.assignee;

                // Set up all event listeners
                document.getElementById('logout').addEventListener('click', handleLogout);
                document.getElementById('refresh-employees').addEventListener('click', loadEmployees);
                document.getElementById('refresh-tickets').addEventListener('click', loadTickets);
                document.getElementById('employee-status-filter').addEventListener('change', loadEmployees);
                document.getElementById('ticket-status-filter').addEventListener('change', loadTickets);
                document.getElementById('employee-sort-order').addEventListener('change', loadEmployees);
                
                // Add ticket sorting and search event listeners
                document.getElementById('ticket-sort')?.addEventListener('change', loadTickets);
                document.getElementById('tickets-next-page')?.addEventListener('click', nextTicketsPage);
                document.getElementById('tickets-prev-page')?.addEventListener('click', prevTicketsPage);
                
                // Add event listener for search
                const searchInput = document.getElementById('ticket-search');
                if (searchInput) {
                    searchInput.addEventListener('keyup', (e) => {
                        // Reset to first page when searching
                        ticketsCurrentPage = 1;
                        
                        // If Enter key pressed or after a delay
                        if (e.key === 'Enter') {
                            loadTickets();
                        } else {
                            clearTimeout(searchInput.debounceTimer);
                            searchInput.debounceTimer = setTimeout(() => {
                                loadTickets();
                            }, 500);
                        }
                    });
                }

                // Set up tab switching
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        document.querySelectorAll('[id$="-tab"]').forEach(tab => tab.classList.add('hidden'));
                        document.getElementById(`${link.dataset.tab}-tab`).classList.remove('hidden');
                        
                        if (link.dataset.tab === 'analytics') {
                            initializeCharts();
                        }
                    });
                });

                // Set up view switching
                document.getElementById('card-view').addEventListener('click', () => {
                    document.getElementById('card-view').classList.add('active');
                    document.getElementById('table-view').classList.remove('active');
                    document.getElementById('employee-cards').classList.remove('hidden');
                    document.getElementById('employee-table').classList.add('hidden');
                });

                document.getElementById('table-view').addEventListener('click', () => {
                    document.getElementById('table-view').classList.add('active');
                    document.getElementById('card-view').classList.remove('active');
                    document.getElementById('employee-table').classList.remove('hidden');
                    document.getElementById('employee-cards').classList.add('hidden');
                });

                // Initial load
                await Promise.all([
                    loadEmployees(),
                    loadTickets(),
                    loadStatistics()
                ]);

                // Set up realtime subscriptions
                setupRealTimeSubscriptions();

                // Hide loading spinner
                document.getElementById('loading').classList.add('hidden');

                // Set up smooth updates
                setupSmoothUpdates();

            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showNotification('Failed to initialize dashboard', 'error');
            }
        });

        // Set up periodic updates
        function setupPeriodicUpdates() {
            setInterval(async () => {
                const { data: employees } = await supabase
                    .from('requests_users')
                    .select('*')
                    .eq('role', 'back-office');

                const { data: activeBreaks } = await supabase
                    .from('employee_breaks')
                    .select('*')
                    .is('end_time', null);

                const breaksByEmail = new Map(activeBreaks.map(break_ => [break_.employee_email, break_]));

                employees.forEach(employee => {
                    const employeeBreak = breaksByEmail.get(employee.email);
                    updateProgressBars(employee, employeeBreak);
                });
            }, 1000); // Update every second for smoother progress
        }

        // Update the updateProgressBars function
        function updateProgressBars(employee, activeBreak) {
            const encodedEmail = encodeEmailForSelector(employee.email);
            const now = new Date();

            // Coffee break progress
            const coffeeProgressBar = document.querySelector(`.coffee-progress-${encodedEmail}`);
            const coffeeTimeDisplay = document.querySelector(`.coffee-time-${encodedEmail}`);
            
            if (employee.status === 'coffee-break' && activeBreak) {
                const startTime = new Date(activeBreak.start_time);
                const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                const remainingMinutes = Math.max(0, 30 - elapsedMinutes);
                const progress = ((30 - remainingMinutes) / 30) * 100;
                
                if (coffeeProgressBar) {
                    coffeeProgressBar.style.width = `${Math.min(100, progress)}%`;
                    coffeeProgressBar.style.backgroundColor = '#f97316'; // Orange color
                }
                if (coffeeTimeDisplay) {
                    coffeeTimeDisplay.textContent = `${remainingMinutes}m left`;
                }
            } else {
                if (coffeeProgressBar) {
                    coffeeProgressBar.style.width = '0%';
                }
                if (coffeeTimeDisplay) {
                    coffeeTimeDisplay.textContent = '30m left';
                }
            }

            // Lunch break progress
            const lunchProgressBar = document.querySelector(`.lunch-progress-${encodedEmail}`);
            const lunchTimeDisplay = document.querySelector(`.lunch-time-${encodedEmail}`);
            
            if (employee.status === 'lunch-break' && activeBreak) {
                const startTime = new Date(activeBreak.start_time);
                const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                const remainingMinutes = Math.max(0, 40 - elapsedMinutes);
                const progress = ((40 - remainingMinutes) / 40) * 100;
                
                if (lunchProgressBar) {
                    lunchProgressBar.style.width = `${Math.min(100, progress)}%`;
                    lunchProgressBar.style.backgroundColor = '#ef4444'; // Red color
                }
                if (lunchTimeDisplay) {
                    lunchTimeDisplay.textContent = `${remainingMinutes}m left`;
                }
            } else {
                if (lunchProgressBar) {
                    lunchProgressBar.style.width = '0%';
                }
                if (lunchTimeDisplay) {
                    lunchTimeDisplay.textContent = '40m left';
                }
            }

            // Login time progress
            const loginProgressBar = document.querySelector(`.login-progress-${encodedEmail}`);
            const loginTimeDisplay = document.querySelector(`.login-time-${encodedEmail}`);
            
            // Calculate total login time from status history
            calculateTotalTimeToday(employee.email).then(totals => {
                const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours in minutes
                const progress = (totals.totalLoginTime / targetLoginMinutes) * 100;
                const remainingMinutes = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
                
                if (loginProgressBar) {
                    loginProgressBar.style.width = `${Math.min(100, progress)}%`;
                    loginProgressBar.style.backgroundColor = '#3b82f6'; // Blue color
                }
                if (loginTimeDisplay) {
                    const hours = Math.floor(remainingMinutes / 60);
                    const minutes = remainingMinutes % 60;
                    loginTimeDisplay.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
                }
            });
        }

        // Update the updateEmployeeData function to include progress bar updates
        function updateEmployeeData(employee, activeBreak, totals) {
            const encodedEmail = encodeEmailForSelector(employee.email);
            
            // Update status
            const statusIndicator = document.querySelector(`.status-${encodedEmail}`);
            if (statusIndicator) {
                statusIndicator.innerHTML = `
                    <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                    ${formatStatus(employee.status)}
                `;
            }

            // Update progress bars and times
            updateProgressBars(employee, activeBreak);

            // Update statistics
            const readyTime = document.querySelector(`.ready-time-${encodedEmail}`);
            const coffeeTime = document.querySelector(`.coffee-total-${encodedEmail}`);
            const lunchTime = document.querySelector(`.lunch-total-${encodedEmail}`);
            
            if (readyTime) readyTime.textContent = formatDurationShort(totals.totalReadyTime);
            if (coffeeTime) coffeeTime.textContent = formatDurationShort(totals.totalCoffeeTime);
            if (lunchTime) lunchTime.textContent = formatDurationShort(totals.totalLunchTime);
        }

        // Add CSS styles for the progress bars
        const style = document.createElement('style');
        style.textContent = `
            .break-timer {
                width: 100%;
                height: 8px;
                background-color: #f3f4f6;
                border-radius: 4px;
                overflow: hidden;
            }

            .break-timer-fill {
                height: 100%;
                transition: width 0.3s ease;
                border-radius: 4px;
            }

            .coffee-progress, .lunch-progress, .login-progress {
                height: 100%;
                transition: width 0.3s ease;
            }
        `;
        document.head.appendChild(style);

        // Add this new function to calculate total times
        function calculateTotalTimes(history) {
            let totalReadyTime = 0;
            let totalCoffeeTime = 0;
            let totalLunchTime = 0;
            let totalLoginTime = 0;

            if (!history || history.length === 0) {
                return { totalReadyTime, totalCoffeeTime, totalLunchTime, totalLoginTime };
            }

            // Sort history by created_at
            history.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            history.forEach((record, index) => {
                const startTime = new Date(record.created_at);
                const endTime = index === history.length - 1 
                    ? new Date() 
                    : new Date(history[index + 1].created_at);
                
                const duration = Math.round((endTime - startTime) / (1000 * 60)); // minutes

                switch (record.new_status) {
                    case 'ready':
                        totalReadyTime += duration;
                        totalLoginTime += duration;
                        break;
                    case 'coffee-break':
                        totalCoffeeTime += duration;
                        totalLoginTime += duration;
                        break;
                    case 'lunch-break':
                        totalLunchTime += duration;
                        totalLoginTime += duration;
                        break;
                    case 'task':
                        totalLoginTime += duration;
                        break;
                }
            });

            return { totalReadyTime, totalCoffeeTime, totalLunchTime, totalLoginTime };
        }

        // Update the updateBreakTimers function
        function updateBreakTimers(employee, activeBreak, totals) {
            if (!employee || !employee.email) return;

            const encodedEmail = encodeEmailForSelector(employee.email);
            const now = new Date();

            // Update coffee break progress
            const coffeeProgress = document.querySelector(`.coffee-progress-${encodedEmail}`);
            const coffeeTime = document.querySelector(`.coffee-time-${encodedEmail}`);
            const coffeeTotal = document.querySelector(`.coffee-total-${encodedEmail}`);

            if (employee.status === 'coffee-break' && activeBreak) {
                const startTime = new Date(activeBreak.start_time);
                const diffMinutes = Math.floor((now - startTime) / (1000 * 60));
                const remainingMinutes = Math.max(0, 30 - diffMinutes);
                const progress = ((30 - remainingMinutes) / 30) * 100;

                if (coffeeProgress) coffeeProgress.style.width = `${Math.min(100, progress)}%`;
                if (coffeeTime) coffeeTime.textContent = `${remainingMinutes}m left`;
            } else {
                if (coffeeProgress) coffeeProgress.style.width = '0%';
                if (coffeeTime) coffeeTime.textContent = '30m left';
            }

            // Update lunch break progress
            const lunchProgress = document.querySelector(`.lunch-progress-${encodedEmail}`);
            const lunchTime = document.querySelector(`.lunch-time-${encodedEmail}`);
            const lunchTotal = document.querySelector(`.lunch-total-${encodedEmail}`);

            if (employee.status === 'lunch-break' && activeBreak) {
                const startTime = new Date(activeBreak.start_time);
                const diffMinutes = Math.floor((now - startTime) / (1000 * 60));
                const remainingMinutes = Math.max(0, 40 - diffMinutes);
                const progress = ((40 - remainingMinutes) / 40) * 100;

                if (lunchProgress) lunchProgress.style.width = `${Math.min(100, progress)}%`;
                if (lunchTime) lunchTime.textContent = `${remainingMinutes}m left`;
            } else {
                if (lunchProgress) lunchProgress.style.width = '0%';
                if (lunchTime) lunchTime.textContent = '40m left';
            }

            // Update total times
            const readyTime = document.querySelector(`.ready-time-${encodedEmail}`);
            if (readyTime) readyTime.textContent = formatDurationShort(totals.totalReadyTime);
            if (coffeeTotal) coffeeTotal.textContent = formatDurationShort(totals.totalCoffeeTime);
            if (lunchTotal) lunchTotal.textContent = formatDurationShort(totals.totalLunchTime);

            // Update login time progress
            const loginProgress = document.querySelector(`.login-progress-${encodedEmail}`);
            const loginTime = document.querySelector(`.login-time-${encodedEmail}`);
            
            if (loginProgress && loginTime) {
                const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours in minutes
                const progress = (totals.totalLoginTime / targetLoginMinutes) * 100;
                const remainingTime = Math.max(0, targetLoginMinutes - totals.totalLoginTime);

                loginProgress.style.width = `${Math.min(100, progress)}%`;
                loginTime.textContent = formatDurationShort(remainingTime) + ' left';
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Destroy existing charts if they exist
            if (statusCharts && typeof statusCharts.destroy === 'function') {
                statusCharts.destroy();
            }
            if (volumeChart && typeof volumeChart.destroy === 'function') {
                volumeChart.destroy();
            }

            // Status Distribution Chart
            const statusCtx = document.getElementById('status-distribution-chart');
            if (statusCtx) {
                statusCharts = new Chart(statusCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Ready', 'Coffee Break', 'Lunch Break', 'Task', 'Offline'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#dcfce7',
                                '#ffedd5',
                                '#fee2e2',
                                '#e0e7ff',
                                '#f3f4f6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Ticket Volume Chart
            const volumeCtx = document.getElementById('ticket-volume-chart');
            if (volumeCtx) {
                volumeChart = new Chart(volumeCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Tickets',
                            data: [],
                            borderColor: '#3b82f6',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateCharts();
        }

        // Update charts with latest data
        async function updateCharts() {
            try {
                // Update status distribution
                const { data: employees } = await supabase
                    .from('requests_users')
                    .select('status')
                    .eq('role', 'back-office');

                const statusCounts = {
                    ready: 0,
                    'coffee-break': 0,
                    'lunch-break': 0,
                    task: 0,
                    offline: 0
                };

                employees.forEach(emp => {
                    statusCounts[emp.status]++;
                });

                if (statusCharts) {
                    statusCharts.data.datasets[0].data = Object.values(statusCounts);
                    statusCharts.update();
                }

                // Update ticket volume
                const { data: tickets } = await supabase
                    .from('tickets')
                    .select('created_at')
                    .order('created_at');

                const hourlyData = {};
                tickets.forEach(ticket => {
                    const hour = new Date(ticket.created_at).getHours();
                    hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                });

                const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
                const data = labels.map((_, i) => hourlyData[i] || 0);

                if (volumeChart) {
                    volumeChart.data.labels = labels;
                    volumeChart.data.datasets[0].data = data;
                    volumeChart.update();
                }
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // Start status timers for all employees
        async function startStatusTimers() {
            const { data: employees } = await supabase
                .from('requests_users')
                .select('email, status, updated_at')
                .eq('role', 'back-office');

            employees.forEach(employee => {
                const durationElement = document.getElementById(`status-duration-${employee.email}`);
                if (durationElement) {
                    const startTime = new Date(employee.updated_at);
                    updateStatusTimer(durationElement, startTime);
                    setInterval(() => updateStatusTimer(durationElement, startTime), 1000);
                }
            });
        }

        // Update status timer display
        function updateStatusTimer(element, startTime) {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            element.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // View employee details
        async function viewEmployeeDetails(email) {
            try {
                const { data: employee } = await supabase
                    .from('requests_users')
                    .select('*')
                    .eq('email', email)
                    .single();

                const { data: breaks } = await supabase
                    .from('employee_breaks')
                    .select('*')
                    .eq('employee_email', email)
                    .order('start_time', { ascending: false });

                const modal = document.getElementById('employee-modal');
                const content = document.getElementById('employee-details-content');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">Employee Information</h4>
                            <p class="text-sm text-gray-500">${employee.assignee}</p>
                            <p class="text-sm text-gray-500">${employee.email}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">Current Status</h4>
                            <p class="text-sm text-gray-500">${formatStatus(employee.status)}</p>
                            <p class="text-sm text-gray-500">Since: ${formatDate(employee.updated_at)}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">Break History</h4>
                            <div class="space-y-2">
                                ${breaks.map(breakRecord => `
                                    <div class="text-sm text-gray-500">
                                        ${formatDate(breakRecord.start_time)} - 
                                        ${breakRecord.end_time ? formatDate(breakRecord.end_time) : 'Ongoing'}
                                        (${breakRecord.break_type})
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading employee details:', error);
                showNotification('Failed to load employee details', 'error');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('employee-modal').classList.add('hidden');
        }

        // Reset employee breaks
        async function resetEmployeeBreaks(email) {
            if (!confirm('Are you sure you want to reset this employee\'s breaks?')) return;

            try {
                const { error } = await supabase
                    .from('employee_breaks')
                    .delete()
                    .eq('employee_email', email);

                if (error) throw error;

                showNotification('Employee breaks reset successfully', 'success');
                loadEmployees();
            } catch (error) {
                console.error('Error resetting employee breaks:', error);
                showNotification('Failed to reset employee breaks', 'error');
            }
        }

        // Send reminder for overdue ticket
        async function sendReminder(ticketId, assignedTo) {
            try {
                const { error } = await supabase
                    .from('tickets')
                    .update({ last_reminder: new Date().toISOString() })
                    .eq('ticket_id', ticketId);

                if (error) throw error;

                showNotification(`Reminder sent for ticket ${ticketId}`, 'success');
            } catch (error) {
                console.error('Error sending reminder:', error);
                showNotification('Failed to send reminder', 'error');
            }
        }

        // Helper functions
        function formatStatus(status) {
            if (!status) {
                return 'Offline'; // Default status if null/undefined
            }
            return status.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function getStatusIcon(status) {
            if (!status) {
                return 'power-off'; // Default icon if null/undefined
            }
            switch (status) {
                case 'ready': return 'check-circle';
                case 'coffee-break': return 'coffee';
                case 'lunch-break': return 'utensils';
                case 'task': return 'tasks';
                case 'offline': return 'power-off';
                default: return 'question-circle';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function formatDuration(dateString) {
            const now = new Date();
            const created = new Date(dateString);
            const diff = Math.floor((now - created) / 1000 / 60); // in minutes
            return `${diff}m`;
        }

        function isOverdue(ticket) {
            const now = new Date();
            const created = new Date(ticket.created_at);
            const diff = Math.floor((now - created) / 1000 / 60); // in minutes
            return diff > 15;
        }

        function isApproachingSLA(ticket) {
            const now = new Date();
            const created = new Date(ticket.created_at);
            const diff = Math.floor((now - created) / 1000 / 60); // in minutes
            return diff > 10 && diff <= 15;
        }

        function calculateHandlingTime(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            return Math.floor((end - start) / 1000 / 60); // in minutes
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-title">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${type.charAt(0).toUpperCase() + type.slice(1)}
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Handle logout
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showNotification('Failed to sign out', 'error');
            }
        }

        // Add these new functions to the script section
        function toggleStatusDropdown(element) {
            const dropdown = element.closest('.status-dropdown');
            document.querySelectorAll('.status-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.remove('active');
            });
            dropdown.classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.status-dropdown')) {
                document.querySelectorAll('.status-dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // View switcher functionality
        document.getElementById('card-view').addEventListener('click', () => {
            document.getElementById('card-view').classList.add('active');
            document.getElementById('table-view').classList.remove('active');
            document.getElementById('employee-cards').classList.remove('hidden');
            document.getElementById('employee-table').classList.add('hidden');
        });

        document.getElementById('table-view').addEventListener('click', () => {
            document.getElementById('table-view').classList.add('active');
            document.getElementById('card-view').classList.remove('active');
            document.getElementById('employee-table').classList.remove('hidden');
            document.getElementById('employee-cards').classList.add('hidden');
        });

        // Add this function to create table rows
        function createEmployeeTableRow(employee, activeBreak, totals) {
            const row = document.createElement('tr');
            row.className = 'even:bg-gray-50 hover:bg-blue-50 transition-all duration-200';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="font-medium text-gray-900">${employee.assignee}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="status-dropdown relative">
                        <span class="status-indicator status-${employee.status} cursor-pointer inline-flex items-center px-4 py-2" onclick="toggleStatusDropdown(this)">
                            <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                            ${formatStatus(employee.status)}
                        </span>
                        <div class="status-dropdown-content">
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'ready')">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Ready
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'coffee-break')">
                                <i class="fas fa-coffee text-orange-500"></i>
                                Coffee Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'lunch-break')">
                                <i class="fas fa-utensils text-red-500"></i>
                                Lunch Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'offline')">
                                <i class="fas fa-power-off text-gray-500"></i>
                                Offline
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-coffee text-orange-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="coffee-progress-${employee.email} h-full bg-orange-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-16 coffee-time-${employee.email}">30m left</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-utensils text-red-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="lunch-progress-${employee.email} h-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-16 lunch-time-${employee.email}">40m left</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-clock text-blue-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="login-progress-${employee.email} h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-16 login-time-${employee.email}">8:30h left</span>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div id="status-duration-${employee.email}" class="text-sm font-medium text-gray-900">00:00:00</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500 w-4"></i>
                            <span class="text-sm text-gray-600">Ready: <span class="font-medium ready-time-${employee.email}">0m</span></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-coffee text-orange-500 w-4"></i>
                            <span class="text-sm text-gray-600">Coffee: <span class="font-medium coffee-total-${employee.email}">0m</span></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-utensils text-red-500 w-4"></i>
                            <span class="text-sm text-gray-600">Lunch: <span class="font-medium lunch-total-${employee.email}">0m</span></span>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-3">
                        <button onclick="showStatusHistory('${employee.email}')" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors duration-200" title="Status History">
                            <i class="fas fa-history"></i>
                        </button>
                        <button onclick="resetEmployeeBreaks('${employee.email}')" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-100 transition-colors duration-200" title="Reset Breaks">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            return row;
        }

        // Update the createEmployeeCard function
        function createEmployeeCard(employee, activeBreak, totals) {
            if (!employee || !employee.email || !employee.assignee) {
                console.error('Invalid employee data provided to createEmployeeCard');
                return createErrorCard('Invalid employee data');
            }

            const status = employee.status || 'offline';
            const encodedEmail = encodeEmailForSelector(employee.email);
            const card = document.createElement('div');
            card.className = 'employee-card';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${employee.assignee}</h3>
                        <p class="text-sm text-gray-500">${employee.email}</p>
                    </div>
                    <div class="status-dropdown">
                        <span class="status-indicator status-${status} cursor-pointer" onclick="toggleStatusDropdown(this)">
                            <i class="fas fa-${getStatusIcon(status)} mr-2"></i>
                            ${formatStatus(status)}
                        </span>
                        <div class="status-dropdown-content">
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'ready')">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Ready
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'coffee-break')">
                                <i class="fas fa-coffee text-orange-500"></i>
                                Coffee Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'lunch-break')">
                                <i class="fas fa-utensils text-red-500"></i>
                                Lunch Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'offline')">
                                <i class="fas fa-power-off text-gray-500"></i>
                                Offline
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Coffee Break (30 min limit)</span>
                            <span class="coffee-time-${encodedEmail}">30m left</span>
                        </div>
                        <div class="break-timer">
                            <div class="coffee-progress-${encodedEmail} h-full" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Lunch Break (40 min limit)</span>
                            <span class="lunch-time-${encodedEmail}">40m left</span>
                        </div>
                        <div class="break-timer">
                            <div class="lunch-progress-${encodedEmail} h-full" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Login Time (8:30h target)</span>
                            <span class="login-time-${encodedEmail}">8:30h left</span>
                        </div>
                        <div class="break-timer">
                            <div class="login-progress-${encodedEmail} h-full" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Ready Time</p>
                            <p class="text-xl font-semibold ready-time-${encodedEmail}">0m</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Break Time</p>
                            <p class="text-xl font-semibold">
                                <span class="coffee-total-${encodedEmail}">0m</span> / 
                                <span class="lunch-total-${encodedEmail}">0m</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="showStatusHistory('${employee.email}')" class="btn btn-secondary">
                        <i class="fas fa-history mr-2"></i>
                        Status History
                    </button>
                    <button onclick="resetEmployeeBreaks('${employee.email}')" class="btn btn-danger">
                        <i class="fas fa-redo-alt mr-2"></i>
                        Reset Breaks
                    </button>
                </div>
            `;

            return card;
        }

        // Add this function to update today's tickets count
        async function updateTodayTicketsCount(email) {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const { data: tickets, error } = await supabase
                    .from('tickets')
                    .select('*')
                    .eq('assigned_to', email)
                    .eq('status', 'closed')
                    .gte('created_at', today.toISOString());

                if (error) throw error;

                const ticketsCount = tickets?.length || 0;
                const element = document.getElementById(`tickets-count-${email}`);
                if (element) {
                    element.textContent = ticketsCount;
                }
            } catch (error) {
                console.error('Error updating tickets count:', error);
            }
        }

        // Add error card function
        function createErrorCard(message) {
            const card = document.createElement('div');
            card.className = 'employee-card bg-red-50';
            card.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <div class="text-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-2xl mb-2"></i>
                        <p class="text-red-600">${message}</p>
                    </div>
                </div>
            `;
            return card;
        }

        // Add function to start working on a ticket
        async function startWorkingOnTicket(ticketId) {
            try {
                const { error } = await supabase
                    .from('tickets')
                    .update({
                        status: 'in-progress',
                        status_changed_at: new Date().toISOString()
                    })
                    .eq('ticket_id', ticketId);

                if (error) throw error;

                showNotification('Started working on ticket ' + ticketId, 'success');
                loadTickets();  // Refresh the tickets list
            } catch (error) {
                console.error('Error starting work on ticket:', error);
                showNotification('Failed to start working on ticket', 'error');
            }
        }

        // Add this function to change employee status
        async function changeEmployeeStatus(email, newStatus) {
            try {
                const { error } = await supabase
                    .from('requests_users')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('email', email);

                if (error) throw error;

                showNotification(`Employee status updated to ${formatStatus(newStatus)}`, 'success');
                loadEmployees();
                updateCharts();
            } catch (error) {
                console.error('Error changing employee status:', error);
                showNotification('Failed to change employee status', 'error');
            }
        }

        // Add these new functions to your JavaScript section:
        async function showStatusHistory(email) {
            try {
                currentHistoryEmail = email;
                const modal = document.getElementById('status-history-modal');
                const dateInput = document.getElementById('history-date');
                
                // Set today as default date
                const today = new Date();
                dateInput.valueAsDate = today;
                
                await refreshStatusHistory();
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading status history:', error);
                showNotification('Failed to load status history', 'error');
            }
        }

        async function refreshStatusHistory() {
            if (!currentHistoryEmail) return;

            try {
                const selectedDate = document.getElementById('history-date').valueAsDate;
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);

                const { data: statusHistory, error } = await supabase
                    .from('employee_status_history')
                    .select('*')
                    .eq('employee_email', currentHistoryEmail)
                    .gte('created_at', startOfDay.toISOString())
                    .lte('created_at', endOfDay.toISOString())
                    .order('created_at', { ascending: true });

                if (error) throw error;

                // Calculate time spent in each status
                let timeInStatus = {
                    ready: 0,
                    task: 0,
                    'coffee-break': 0,
                    'lunch-break': 0
                };

                statusHistory.forEach((record, index) => {
                    const startTime = new Date(record.created_at);
                    const endTime = index === statusHistory.length - 1 
                        ? new Date() 
                        : new Date(statusHistory[index + 1].created_at);
                    
                    const duration = Math.round((endTime - startTime) / (1000 * 60)); // minutes
                    
                    if (timeInStatus.hasOwnProperty(record.new_status)) {
                        timeInStatus[record.new_status] += duration;
                    }
                });

                // Update time summary with formatted durations
                document.getElementById('ready-time').textContent = formatDurationWithHours(timeInStatus.ready);
                document.getElementById('task-time').textContent = formatDurationWithHours(timeInStatus.task);
                document.getElementById('coffee-time').textContent = formatDurationWithHours(timeInStatus['coffee-break']);
                document.getElementById('lunch-time').textContent = formatDurationWithHours(timeInStatus['lunch-break']);
                
                const totalActiveTime = timeInStatus.ready + timeInStatus.task + 
                    timeInStatus['coffee-break'] + timeInStatus['lunch-break'];
                document.getElementById('total-time').textContent = formatDurationWithHours(totalActiveTime);

                // Update history table
                const content = document.getElementById('status-history-content');
                content.innerHTML = statusHistory.map((record, index) => {
                    const startTime = new Date(record.created_at);
                    const endTime = index === statusHistory.length - 1 
                        ? new Date() 
                        : new Date(statusHistory[index + 1].created_at);
                    const duration = Math.round((endTime - startTime) / (1000 * 60)); // minutes

                    return `
                        <tr class="hover:bg-gray-50 transition-all duration-150">
                            <td class="px-6 py-4">
                                <span class="status-indicator status-${record.new_status}">
                                    <i class="fas fa-${getStatusIcon(record.new_status)} mr-2"></i>
                                    ${formatStatus(record.new_status)}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">${formatTime(startTime)}</td>
                            <td class="px-6 py-4 text-sm text-gray-600">${index === statusHistory.length - 1 ? 'Current' : formatTime(endTime)}</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatDurationWithHours(duration)}</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="4" class="text-center py-8 text-gray-500">No status changes on selected date</td></tr>';

            } catch (error) {
                console.error('Error refreshing status history:', error);
                showNotification('Failed to refresh status history', 'error');
            }
        }

        function closeStatusHistory() {
            document.getElementById('status-history-modal').classList.add('hidden');
            currentHistoryEmail = null;
        }

        // Add this new function to format duration
        function formatDurationWithHours(minutes) {
            if (!minutes || minutes < 1) return '0 minutes';
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (hours === 0) {
                return `${minutes} minutes`;
            } else if (remainingMinutes === 0) {
                return hours === 1 ? '1 hour' : `${hours} hours`;
            } else {
                const hourText = hours === 1 ? 'hour' : 'hours';
                return `${hours} ${hourText} ${remainingMinutes} min`;
            }
        }

        // Add these functions after the existing updateBreakTimers function
        async function calculateTotalTimeToday(email) {
            try {
                const encodedEmail = encodeEmailForSelector(email);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const { data: history, error } = await supabase
                    .from('employee_status_history')
                    .select('*')
                    .eq('employee_email', email)
                    .gte('created_at', today.toISOString())
                    .order('created_at', { ascending: true });

                if (error) throw error;

                let totalReadyTime = 0;
                let totalCoffeeTime = 0;
                let totalLunchTime = 0;
                let totalLoginTime = 0;

                history.forEach((record, index) => {
                    const startTime = new Date(record.created_at);
                    const endTime = index === history.length - 1 
                        ? new Date() 
                        : new Date(history[index + 1].created_at);
                    
                    const duration = Math.round((endTime - startTime) / (1000 * 60)); // minutes

                    switch (record.new_status) {
                        case 'ready':
                            totalReadyTime += duration;
                            totalLoginTime += duration;
                            break;
                        case 'coffee-break':
                            totalCoffeeTime += duration;
                            totalLoginTime += duration;
                            break;
                        case 'lunch-break':
                            totalLunchTime += duration;
                            totalLoginTime += duration;
                            break;
                    }
                });

                // Update the stats display
                const readyTimeElement = document.querySelector(`.ready-time-${encodedEmail}`);
                const coffeeTimeElement = document.querySelector(`.coffee-total-${encodedEmail}`);
                const lunchTimeElement = document.querySelector(`.lunch-total-${encodedEmail}`);

                if (readyTimeElement) readyTimeElement.textContent = formatDurationShort(totalReadyTime);
                if (coffeeTimeElement) coffeeTimeElement.textContent = formatDurationShort(totalCoffeeTime);
                if (lunchTimeElement) lunchTimeElement.textContent = formatDurationShort(totalLunchTime);

                // Update login time progress
                const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours in minutes
                const loginProgress = (totalLoginTime / targetLoginMinutes) * 100;
                const loginProgressElement = document.querySelector(`.login-progress-${encodedEmail}`);
                const loginTimeElement = document.querySelector(`.login-time-${encodedEmail}`);

                if (loginProgressElement) {
                    loginProgressElement.style.width = `${Math.min(100, loginProgress)}%`;
                }
                if (loginTimeElement) {
                    const remainingTime = Math.max(0, targetLoginMinutes - totalLoginTime);
                    const hours = Math.floor(remainingTime / 60);
                    const minutes = remainingTime % 60;
                    // Use consistent format
                    loginTimeElement.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
                }

                return { totalReadyTime, totalCoffeeTime, totalLunchTime, totalLoginTime };
            } catch (error) {
                console.error('Error calculating total time:', error);
                return { totalReadyTime: 0, totalCoffeeTime: 0, totalLunchTime: 0, totalLoginTime: 0 };
            }
        }

        function formatDurationShort(minutes) {
            if (minutes < 60) {
                return `${minutes}m`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                // Use consistent format "Xh XXm" with padded minutes
                return `${hours}h ${remainingMinutes.toString().padStart(2, '0')}m`;
            }
        }

        // Add this helper function after the formatDurationShort function
        function encodeEmailForSelector(email) {
            return email.replace(/[@.]/g, '_');
        }

        // Update the createEmployeeTableRow function to use encoded email
        function createEmployeeTableRow(employee, activeBreak, totals) {
            const encodedEmail = encodeEmailForSelector(employee.email);
            const row = document.createElement('tr');
            row.className = 'even:bg-gray-50 hover:bg-blue-50 transition-all duration-200';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="font-medium text-gray-900">${employee.assignee}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="status-dropdown relative">
                        <span class="status-indicator status-${employee.status} cursor-pointer inline-flex items-center px-4 py-2" onclick="toggleStatusDropdown(this)">
                            <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                            ${formatStatus(employee.status)}
                        </span>
                        <div class="status-dropdown-content">
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'ready')">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Ready
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'coffee-break')">
                                <i class="fas fa-coffee text-orange-500"></i>
                                Coffee Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'lunch-break')">
                                <i class="fas fa-utensils text-red-500"></i>
                                Lunch Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'offline')">
                                <i class="fas fa-power-off text-gray-500"></i>
                                Offline
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-coffee text-orange-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="coffee-progress-${encodedEmail} h-full bg-orange-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-16 coffee-time-${encodedEmail}">30m left</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-utensils text-red-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="lunch-progress-${encodedEmail} h-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-16 lunch-time-${encodedEmail}">40m left</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-clock text-blue-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="login-progress-${encodedEmail} h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-16 login-time-${encodedEmail}">8:30h left</span>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div id="status-duration-${encodedEmail}" class="text-sm font-medium text-gray-900">00:00:00</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500 w-4"></i>
                            <span class="text-sm text-gray-600">Ready: <span class="font-medium ready-time-${encodedEmail}">0m</span></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-coffee text-orange-500 w-4"></i>
                            <span class="text-sm text-gray-600">Coffee: <span class="font-medium coffee-total-${encodedEmail}">0m</span></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-utensils text-red-500 w-4"></i>
                            <span class="text-sm text-gray-600">Lunch: <span class="font-medium lunch-total-${encodedEmail}">0m</span></span>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-3">
                        <button onclick="showStatusHistory('${employee.email}')" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors duration-200" title="Status History">
                            <i class="fas fa-history"></i>
                        </button>
                        <button onclick="resetEmployeeBreaks('${employee.email}')" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-100 transition-colors duration-200" title="Reset Breaks">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            return row;
        }

        // Update the updateBreakTimers function to use encoded email
        async function updateBreakTimers(employee, activeBreak, totals) {
            try {
                const encodedEmail = encodeEmailForSelector(employee.email);
                // Calculate break times
                const { data: breaks, error } = await supabase
                    .from('employee_breaks')
                    .select('*')
                    .eq('employee_email', employee.email)
                    .is('end_time', null)
                    .order('start_time', { ascending: false })
                    .limit(1);

                if (error) throw error;

                const currentBreak = breaks?.[0];
                
                // Update coffee break progress
                if (employee.status === 'coffee-break' && currentBreak) {
                    const startTime = new Date(currentBreak.start_time);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 30 - diffMinutes);
                    const progress = ((30 - remainingMinutes) / 30) * 100;

                    const coffeeProgress = document.querySelector(`.coffee-progress-${encodedEmail}`);
                    const coffeeTime = document.querySelector(`.coffee-time-${encodedEmail}`);

                    if (coffeeProgress) coffeeProgress.style.width = `${Math.min(100, progress)}%`;
                    if (coffeeTime) coffeeTime.textContent = `${remainingMinutes}m left`;
                } else {
                    const coffeeProgress = document.querySelector(`.coffee-progress-${encodedEmail}`);
                    const coffeeTime = document.querySelector(`.coffee-time-${encodedEmail}`);

                    if (coffeeProgress) coffeeProgress.style.width = '0%';
                    if (coffeeTime) coffeeTime.textContent = '30m left';
                }

                // Update lunch break progress
                if (employee.status === 'lunch-break' && currentBreak) {
                    const startTime = new Date(currentBreak.start_time);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 40 - diffMinutes);
                    const progress = ((40 - remainingMinutes) / 40) * 100;

                    const lunchProgress = document.querySelector(`.lunch-progress-${encodedEmail}`);
                    const lunchTime = document.querySelector(`.lunch-time-${encodedEmail}`);

                    if (lunchProgress) lunchProgress.style.width = `${Math.min(100, progress)}%`;
                    if (lunchTime) lunchTime.textContent = `${remainingMinutes}m left`;
                } else {
                    const lunchProgress = document.querySelector(`.lunch-progress-${encodedEmail}`);
                    const lunchTime = document.querySelector(`.lunch-time-${encodedEmail}`);

                    if (lunchProgress) lunchProgress.style.width = '0%';
                    if (lunchTime) lunchTime.textContent = '40m left';
                }

                // Update total times
                await calculateTotalTimeToday(employee.email);

            } catch (error) {
                console.error('Error updating break timers:', error);
            }
        }

        // Update the calculateTotalTimeToday function to use encoded email
        async function calculateTotalTimeToday(email) {
            try {
                const encodedEmail = encodeEmailForSelector(email);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const { data: history, error } = await supabase
                    .from('employee_status_history')
                    .select('*')
                    .eq('employee_email', email)
                    .gte('created_at', today.toISOString())
                    .order('created_at', { ascending: true });

                if (error) throw error;

                let totalReadyTime = 0;
                let totalCoffeeTime = 0;
                let totalLunchTime = 0;
                let totalLoginTime = 0;

                history.forEach((record, index) => {
                    const startTime = new Date(record.created_at);
                    const endTime = index === history.length - 1 
                        ? new Date() 
                        : new Date(history[index + 1].created_at);
                    
                    const duration = Math.round((endTime - startTime) / (1000 * 60)); // minutes

                    switch (record.new_status) {
                        case 'ready':
                            totalReadyTime += duration;
                            totalLoginTime += duration;
                            break;
                        case 'coffee-break':
                            totalCoffeeTime += duration;
                            totalLoginTime += duration;
                            break;
                        case 'lunch-break':
                            totalLunchTime += duration;
                            totalLoginTime += duration;
                            break;
                    }
                });

                // Update the stats display
                const readyTimeElement = document.querySelector(`.ready-time-${encodedEmail}`);
                const coffeeTimeElement = document.querySelector(`.coffee-total-${encodedEmail}`);
                const lunchTimeElement = document.querySelector(`.lunch-total-${encodedEmail}`);

                if (readyTimeElement) readyTimeElement.textContent = formatDurationShort(totalReadyTime);
                if (coffeeTimeElement) coffeeTimeElement.textContent = formatDurationShort(totalCoffeeTime);
                if (lunchTimeElement) lunchTimeElement.textContent = formatDurationShort(totalLunchTime);

                // Update login time progress
                const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours in minutes
                const loginProgress = (totalLoginTime / targetLoginMinutes) * 100;
                const loginProgressElement = document.querySelector(`.login-progress-${encodedEmail}`);
                const loginTimeElement = document.querySelector(`.login-time-${encodedEmail}`);

                if (loginProgressElement) {
                    loginProgressElement.style.width = `${Math.min(100, loginProgress)}%`;
                }
                if (loginTimeElement) {
                    const remainingTime = Math.max(0, targetLoginMinutes - totalLoginTime);
                    const hours = Math.floor(remainingTime / 60);
                    const minutes = remainingTime % 60;
                    // Use consistent format
                    loginTimeElement.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
                }

                return { totalReadyTime, totalCoffeeTime, totalLunchTime, totalLoginTime };
            } catch (error) {
                console.error('Error calculating total time:', error);
                return { totalReadyTime: 0, totalCoffeeTime: 0, totalLunchTime: 0, totalLoginTime: 0 };
            }
        }

        // Load and display tickets
        let ticketsCurrentPage = 1;
        let ticketsPerPage = 100;
        let ticketsTotal = 0;
        let allTickets = [];

        async function loadTickets() {
            try {
                // Show loading state
                const refreshButton = document.getElementById('refresh-tickets');
                if (refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                    refreshButton.disabled = true;
                }

                // Get query params
                const statusFilter = document.getElementById('ticket-status-filter')?.value || 'all';
                const searchQuery = document.getElementById('ticket-search')?.value || '';
                const sortOrder = document.getElementById('ticket-sort')?.value || 'newest';

                // Fetch all tickets
                const { data: tickets, error } = await supabase
                    .from('tickets')
                    .select('*')
                    .order('created_at', { ascending: sortOrder === 'oldest' });

                if (error) throw error;
                
                // Fetch all users in one query
                const { data: users } = await supabase
                    .from('requests_users')
                    .select('email, assignee');
                
                // Create a map of users by email for efficient lookup
                const userMap = {};
                if (users && users.length > 0) {
                    users.forEach(user => {
                        userMap[user.email] = user.assignee;
                    });
                }
                
                console.log("Found users:", Object.keys(userMap).length);
                
                // Enhance tickets with assignee information
                const enhancedTickets = tickets.map(ticket => {
                    // Get the assignee name from the user map if it exists
                    const assigneeName = ticket.assigned_to && userMap[ticket.assigned_to] 
                        ? userMap[ticket.assigned_to] 
                        : (ticket.assigned_to ? ticket.assigned_to : 'Unassigned');
                    
                    return {
                        ...ticket,
                        assignee_name: assigneeName
                    };
                });

                // Apply filters
                allTickets = enhancedTickets || [];
                
                let filteredTickets = allTickets.filter(ticket => {
                    // Apply status filter
                    if (statusFilter === 'all') {
                        // No status filter
                    } else if (statusFilter === 'overdue') {
                        if (!isOverdue(ticket)) return false;
                    } else if (statusFilter === 'approaching') {
                        if (!isApproachingSLA(ticket)) return false;
                    } else if (ticket.status !== statusFilter) {
                        return false;
                    }

                    // Apply search filter
                    if (searchQuery) {
                        const ticketId = String(ticket.ticket_id || '');
                        if (!ticketId.includes(searchQuery)) {
                            return false;
                        }
                    }

                    return true;
                });

                // Sort by priority if needed
                if (sortOrder === 'priority') {
                    filteredTickets.sort((a, b) => {
                        // Priority: Overdue > Approaching SLA > New > In Progress > Closed
                        const getPriority = (ticket) => {
                            if (isOverdue(ticket)) return 1;
                            if (isApproachingSLA(ticket)) return 2;
                            if (ticket.status === 'new') return 3;
                            if (ticket.status === 'in-progress') return 4;
                            return 5; // closed or other
                        };
                        return getPriority(a) - getPriority(b);
                    });
                }

                // Update counters
                ticketsTotal = filteredTickets.length;
                const totalPages = Math.ceil(ticketsTotal / ticketsPerPage);
                
                // Make sure current page is valid
                if (ticketsCurrentPage > totalPages && totalPages > 0) {
                    ticketsCurrentPage = totalPages;
                } else if (ticketsCurrentPage < 1) {
                    ticketsCurrentPage = 1;
                }

                // Apply pagination
                const startIndex = (ticketsCurrentPage - 1) * ticketsPerPage;
                const endIndex = Math.min(startIndex + ticketsPerPage, filteredTickets.length);
                const paginatedTickets = filteredTickets.slice(startIndex, endIndex);

                // Update UI
                const container = document.getElementById('tickets-container');
                if (!container) {
                    console.error('Tickets container not found');
                    return;
                }

                // Clear existing content
                container.innerHTML = '';

                if (filteredTickets.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-ticket-alt text-gray-400 text-4xl mb-3"></i>
                            <p class="text-gray-500">No tickets found</p>
                        </div>
                    `;
                } else {
                    // Create and append ticket cards
                    paginatedTickets.forEach(ticket => {
                        const card = createTicketCard(ticket);
                        container.appendChild(card);
                    });
                }

                // Update pagination controls
                updatePaginationControls(filteredTickets.length, startIndex, endIndex);

                // Update statistics
                updateTicketStatistics(allTickets);

            } catch (error) {
                console.error('Error loading tickets:', error);
                showNotification('Failed to load tickets', 'error');
            } finally {
                // Restore refresh button
                const refreshButton = document.getElementById('refresh-tickets');
                if (refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    refreshButton.disabled = false;
                }
            }
        }

        // Update pagination controls
        function updatePaginationControls(totalItems, startIndex, endIndex) {
            document.getElementById('tickets-showing').textContent = totalItems > 0 ? `${startIndex + 1}-${endIndex}` : '0';
            document.getElementById('tickets-total').textContent = totalItems;
            
            const prevButton = document.getElementById('tickets-prev-page');
            const nextButton = document.getElementById('tickets-next-page');
            
            prevButton.disabled = ticketsCurrentPage <= 1;
            nextButton.disabled = endIndex >= totalItems;
        }

        // Update ticket statistics
        function updateTicketStatistics(tickets) {
            const totalCount = tickets.length;
            const newCount = tickets.filter(t => t.status === 'new').length;
            const inProgressCount = tickets.filter(t => t.status === 'in-progress').length;
            const closedCount = tickets.filter(t => t.status === 'closed').length;
            const overdueCount = tickets.filter(t => isOverdue(t)).length;
            
            document.getElementById('total-tickets-count').textContent = totalCount;
            document.getElementById('new-tickets-count').textContent = newCount;
            document.getElementById('in-progress-tickets-count').textContent = inProgressCount;
            document.getElementById('closed-tickets-count').textContent = closedCount;
            document.getElementById('overdue-tickets-count').textContent = overdueCount;
        }

        // Create ticket card with assigned_to info
        function createTicketCard(ticket) {
            const card = document.createElement('div');
            const isTicketOverdue = isOverdue(ticket);
            const isTicketApproaching = isApproachingSLA(ticket);
            
            let statusClass = '';
            switch(ticket.status) {
                case 'new': statusClass = 'badge-new'; break;
                case 'in-progress': statusClass = 'badge-in-progress'; break;
                case 'closed': statusClass = 'badge-closed'; break;
                default: statusClass = 'badge-new';
            }
            
            if (isTicketOverdue) {
                statusClass = 'badge-overdue';
            }
            
            const borderClass = isTicketOverdue ? 'border-red-500' : 
                                isTicketApproaching ? 'border-yellow-500' : 
                                'border-blue-500';
            
            card.className = `ticket-card border-l-4 ${borderClass}`;
            
            // Get assignee name from the attached user data
            const isAssigned = !!ticket.assigned_to;
            const assigneeName = ticket.assignee_name || 'Unassigned';
            const assigneeIcon = isAssigned ? 'fa-user' : 'fa-user-slash';
            const assigneeClass = isAssigned ? 'bg-green-50 text-green-600' : 'bg-gray-50 text-gray-500';
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <h4 class="font-semibold text-gray-800">Ticket #${ticket.ticket_id}</h4>
                        <span class="ticket-badge ${statusClass}">
                            ${isTicketOverdue ? 'Overdue' : formatStatus(ticket.status)}
                        </span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-xs text-gray-500">Created: ${formatDate(ticket.created_at)}</span>
                        <span class="text-xs font-medium ${
                            isTicketOverdue ? 'text-red-500' :
                            isTicketApproaching ? 'text-yellow-500' :
                            'text-gray-500'
                        }">
                            ${formatDuration(ticket.created_at)}
                        </span>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <div class="ticket-assigned ${assigneeClass}">
                        <i class="fas ${assigneeIcon} mr-1"></i>
                        <span>${assigneeName}</span>
                    </div>
                    <div class="flex space-x-2">
                        ${ticket.status === 'new' ? `
                            <button onclick="startWorkingOnTicket('${ticket.ticket_id}')" 
                                class="btn btn-sm btn-primary">
                                <i class="fas fa-play mr-1"></i>
                                Start Working
                            </button>
                        ` : ''}
                        ${isTicketOverdue ? `
                            <button onclick="sendReminder('${ticket.ticket_id}', '${ticket.assigned_to || ''}')" 
                                class="btn btn-sm btn-danger">
                                <i class="fas fa-bell mr-1"></i>
                                Send Reminder
                            </button>
                        ` : ''}
                    </div>
                </div>
                ${ticket.description ? `
                    <div class="mt-2 text-sm text-gray-600 border-t border-gray-100 pt-2">
                        <p class="line-clamp-1">${ticket.description}</p>
                    </div>
                ` : ''}
            `;
            return card;
        }

        // Update function to handle pagination
        function nextTicketsPage() {
            ticketsCurrentPage++;
            loadTickets();
        }

        function prevTicketsPage() {
            if (ticketsCurrentPage > 1) {
                ticketsCurrentPage--;
                loadTickets();
            }
        }

        // Add event listeners for search and pagination
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners for pagination
            document.getElementById('tickets-next-page')?.addEventListener('click', nextTicketsPage);
            document.getElementById('tickets-prev-page')?.addEventListener('click', prevTicketsPage);
            
            // Add event listener for search
            const searchInput = document.getElementById('ticket-search');
            if (searchInput) {
                searchInput.addEventListener('keyup', (e) => {
                    // Reset to first page when searching
                    ticketsCurrentPage = 1;
                    
                    // If Enter key pressed or after a delay
                    if (e.key === 'Enter') {
                        loadTickets();
                    } else {
                        clearTimeout(searchInput.debounceTimer);
                        searchInput.debounceTimer = setTimeout(() => {
                            loadTickets();
                        }, 500);
                    }
                });
            }
            
            // Add event listener for sort change
            document.getElementById('ticket-sort')?.addEventListener('change', () => {
                ticketsCurrentPage = 1; // Reset to first page
                loadTickets();
            });
        });

        // Add tab switching functionality
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    // Remove active class from all links
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    link.classList.add('active');
                    
                    // Hide all tabs
                    document.querySelectorAll('[id$="-tab"]').forEach(tab => tab.classList.add('hidden'));
                    // Show selected tab
                    document.getElementById(`${link.dataset.tab}-tab`).classList.remove('hidden');
                    
                    // Initialize charts if analytics tab is selected
                    if (link.dataset.tab === 'analytics') {
                        initializeCharts();
                    }
                });
            });
        });

        // Add view switcher functionality
        document.addEventListener('DOMContentLoaded', () => {
            const cardView = document.getElementById('card-view');
            const tableView = document.getElementById('table-view');
            const employeeCards = document.getElementById('employee-cards');
            const employeeTable = document.getElementById('employee-table');

            if (cardView && tableView && employeeCards && employeeTable) {
                cardView.addEventListener('click', () => {
                    cardView.classList.add('active');
                    tableView.classList.remove('active');
                    employeeCards.classList.remove('hidden');
                    employeeTable.classList.add('hidden');
                });

                tableView.addEventListener('click', () => {
                    tableView.classList.add('active');
                    cardView.classList.remove('active');
                    employeeTable.classList.remove('hidden');
                    employeeCards.classList.add('hidden');
                });
            }
        });

        // Format time for status history display
        function formatTime(date) {
            if (!date) return 'N/A';
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Add this function to load and display employees
        async function loadEmployees() {
            try {
                // Show loading indicator
                const refreshButton = document.getElementById('refresh-employees');
                if (refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                    refreshButton.disabled = true;
                }

                const statusFilter = document.getElementById('employee-status-filter').value;
                const sortOrder = document.getElementById('employee-sort-order').value;
                
                console.log(`Loading employees with filter: ${statusFilter}, sort: ${sortOrder}`);
                
                // Get all data in parallel
                const [employeesResponse, breaksResponse, historyResponse] = await Promise.all([
                    supabase.from('requests_users')
                        .select('*')
                        .eq('role', 'back-office')
                        .order('assignee'),
                    supabase.from('employee_breaks')
                        .select('*')
                        .is('end_time', null),
                    supabase.from('employee_status_history')
                        .select('*')
                        .gte('created_at', new Date().toISOString().split('T')[0])
                ]);

                if (employeesResponse.error) throw employeesResponse.error;

                const employees = employeesResponse.data;
                console.log(`Found ${employees ? employees.length : 0} total employees`);
                
                const breaksByEmail = new Map(breaksResponse.data.map(break_ => [break_.employee_email, break_]));
                const historyByEmail = new Map();
                
                historyResponse.data.forEach(record => {
                    if (!historyByEmail.has(record.employee_email)) {
                        historyByEmail.set(record.employee_email, []);
                    }
                    historyByEmail.get(record.employee_email).push(record);
                });

                // Filter employees based on status
                let filteredEmployees = statusFilter === 'all' 
                    ? employees 
                    : employees.filter(emp => emp.status === statusFilter);
                    
                console.log(`Filtered to ${filteredEmployees.length} employees based on status: ${statusFilter}`);
                    
                // Sort employees based on selected criteria
                filteredEmployees = sortEmployees(filteredEmployees, sortOrder);
                console.log(`Sorted employees based on: ${sortOrder}`);

                // Clear existing containers completely before adding new cards/rows
                const cardsContainer = document.getElementById('employee-cards');
                const tableBody = document.getElementById('employee-table-body');
                
                if (cardsContainer) cardsContainer.innerHTML = '';
                if (tableBody) tableBody.innerHTML = '';

                console.log(`Displaying ${filteredEmployees.length} employees`);

                // Create and append all cards/rows at once
                filteredEmployees.forEach((employee, index) => {
                    const employeeBreak = breaksByEmail.get(employee.email);
                    const employeeHistory = historyByEmail.get(employee.email) || [];
                    const totals = calculateTotalTimes(employeeHistory);
                    const encodedEmail = encodeEmailForSelector(employee.email);

                    // Create and append card
                    if (cardsContainer) {
                        const card = document.createElement('div');
                        card.className = 'employee-card';
                        card.setAttribute('data-email', employee.email);
                        card.setAttribute('data-status-time', employee.updated_at);
                        card.id = `employee-card-${encodedEmail}`;
                        card.setAttribute('data-status', employee.status);
                        card.setAttribute('data-priority', 
                            employee.status === 'lunch-break' ? '1' : 
                            employee.status === 'coffee-break' ? '2' : 
                            employee.status === 'ready' ? '3' : '4');
                        
                        // Create card content
                        card.innerHTML = createEmployeeCardHTML(employee, encodedEmail, totals);
                        cardsContainer.appendChild(card);
                    }

                    // Create and append table row
                    if (tableBody) {
                        const row = document.createElement('tr');
                        row.className = 'even:bg-gray-50 hover:bg-blue-50 transition-all duration-200';
                        row.setAttribute('data-email', employee.email);
                        row.setAttribute('data-status-time', employee.updated_at);
                        row.id = `employee-row-${encodedEmail}`;
                        row.setAttribute('data-status', employee.status);
                        row.setAttribute('data-priority', 
                            employee.status === 'lunch-break' ? '1' : 
                            employee.status === 'coffee-break' ? '2' : 
                            employee.status === 'ready' ? '3' : '4');
                        
                        // Create row content
                        row.innerHTML = createEmployeeRowHTML(employee, encodedEmail, totals);
                        tableBody.appendChild(row);
                    }

                    // Update break timers
                    updateBreakProgressBars(employee, employeeBreak);
                    startStatusTimer(employee);
                });

                // Restore refresh button
                if (refreshButton) {
                    setTimeout(() => {
                        refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                        refreshButton.disabled = false;
                    }, 1000);
                }

            } catch (error) {
                console.error('Error loading employees:', error);
                showNotification('Failed to load employees', 'error');
                
                // Restore refresh button on error
                const refreshButton = document.getElementById('refresh-employees');
                if (refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    refreshButton.disabled = false;
                }
            }
        }

        // Function to update just the data in an existing card
        function updateEmployeeCardData(card, employee, activeBreak, totals) {
            const now = new Date();
            
            // Update status
            const statusIndicator = card.querySelector('.status-indicator');
            if (statusIndicator) {
                statusIndicator.className = `status-indicator status-${employee.status}`;
                statusIndicator.innerHTML = `
                    <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                    ${formatStatus(employee.status)}
                `;
            }

            // Update break timers and progress bars
            if (activeBreak) {
                const startTime = new Date(activeBreak.start_time);
                if (employee.status === 'coffee-break') {
                    const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 30 - elapsedMinutes);
                    const progress = ((30 - remainingMinutes) / 30) * 100;
                    
                    const progressBar = card.querySelector('.coffee-progress');
                    const timeDisplay = card.querySelector('.coffee-time');
                    if (progressBar) progressBar.style.width = `${Math.min(100, progress)}%`;
                    if (timeDisplay) timeDisplay.textContent = `${remainingMinutes}m left`;
                } else if (employee.status === 'lunch-break') {
                    const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 40 - elapsedMinutes);
                    const progress = ((40 - remainingMinutes) / 40) * 100;
                    
                    const progressBar = card.querySelector('.lunch-progress');
                    const timeDisplay = card.querySelector('.lunch-time');
                    if (progressBar) progressBar.style.width = `${Math.min(100, progress)}%`;
                    if (timeDisplay) timeDisplay.textContent = `${remainingMinutes}m left`;
                }
            }

            // Update statistics
            const readyTime = card.querySelector('.ready-time');
            const coffeeTime = card.querySelector('.coffee-total');
            const lunchTime = card.querySelector('.lunch-total');
            
            if (readyTime) readyTime.textContent = formatDurationShort(totals.totalReadyTime);
            if (coffeeTime) coffeeTime.textContent = formatDurationShort(totals.totalCoffeeTime);
            if (lunchTime) lunchTime.textContent = formatDurationShort(totals.totalLunchTime);

            // Update login time
            const targetLoginMinutes = 8 * 60 + 30;
            const loginProgress = (totals.totalLoginTime / targetLoginMinutes) * 100;
            const remainingLoginTime = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
            
            const loginProgressBar = card.querySelector('.login-progress');
            const loginTimeDisplay = card.querySelector('.login-time');
            
            if (loginProgressBar) loginProgressBar.style.width = `${Math.min(100, loginProgress)}%`;
            if (loginTimeDisplay) {
                const hours = Math.floor(remainingLoginTime / 60);
                const minutes = remainingLoginTime % 60;
                loginTimeDisplay.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
            }
        }

        // Similar function for table rows
        function updateEmployeeRowData(row, employee, activeBreak, totals) {
            // Similar to updateEmployeeCardData but for table row elements
            const now = new Date();
            
            // Update status
            const statusIndicator = row.querySelector('.status-indicator');
            if (statusIndicator) {
                statusIndicator.className = `status-indicator status-${employee.status}`;
                statusIndicator.innerHTML = `
                    <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                    ${formatStatus(employee.status)}
                `;
            }

            // Update break timers and progress bars
            if (activeBreak) {
                const startTime = new Date(activeBreak.start_time);
                if (employee.status === 'coffee-break') {
                    const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 30 - elapsedMinutes);
                    const progress = ((30 - remainingMinutes) / 30) * 100;
                    
                    const progressBar = row.querySelector('.coffee-progress');
                    const timeDisplay = row.querySelector('.coffee-time');
                    if (progressBar) progressBar.style.width = `${Math.min(100, progress)}%`;
                    if (timeDisplay) timeDisplay.textContent = `${remainingMinutes}m left`;
                } else if (employee.status === 'lunch-break') {
                    const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 40 - elapsedMinutes);
                    const progress = ((40 - remainingMinutes) / 40) * 100;
                    
                    const progressBar = row.querySelector('.lunch-progress');
                    const timeDisplay = row.querySelector('.lunch-time');
                    if (progressBar) progressBar.style.width = `${Math.min(100, progress)}%`;
                    if (timeDisplay) timeDisplay.textContent = `${remainingMinutes}m left`;
                }
            }

            // Update time in status
            const statusDuration = row.querySelector('.status-duration');
            if (statusDuration) {
                const startTime = new Date(employee.updated_at);
                const duration = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(duration / 3600);
                const minutes = Math.floor((duration % 3600) / 60);
                const seconds = duration % 60;
                statusDuration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Update statistics
            const readyTime = row.querySelector('.ready-time');
            const coffeeTime = row.querySelector('.coffee-total');
            const lunchTime = row.querySelector('.lunch-total');
            
            if (readyTime) readyTime.textContent = formatDurationShort(totals.totalReadyTime);
            if (coffeeTime) coffeeTime.textContent = formatDurationShort(totals.totalCoffeeTime);
            if (lunchTime) lunchTime.textContent = formatDurationShort(totals.totalLunchTime);

            // Update login time
            const targetLoginMinutes = 8 * 60 + 30;
            const loginProgress = (totals.totalLoginTime / targetLoginMinutes) * 100;
            const remainingLoginTime = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
            
            const loginProgressBar = row.querySelector('.login-progress');
            const loginTimeDisplay = row.querySelector('.login-time');
            
            if (loginProgressBar) loginProgressBar.style.width = `${Math.min(100, loginProgress)}%`;
            if (loginTimeDisplay) {
                const hours = Math.floor(remainingLoginTime / 60);
                const minutes = remainingLoginTime % 60;
                loginTimeDisplay.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
            }
        }

        // Improved setupSmoothUpdates function
        function setupSmoothUpdates() {
            // Update status timers every second
            setInterval(() => {
                document.querySelectorAll('[id^="status-duration-"]').forEach(el => {
                    const encodedEmail = el.id.replace('status-duration-', '');
                    const employee = document.querySelector(`[data-email="${decodeEmailForSelector(encodedEmail)}"]`);
                    if (employee) {
                        const startTimeStr = employee.getAttribute('data-status-time');
                        if (startTimeStr) {
                            const startTime = new Date(startTimeStr);
                            const now = new Date();
                            const diff = Math.floor((now - startTime) / 1000);
                            const hours = Math.floor(diff / 3600);
                            const minutes = Math.floor((diff % 3600) / 60);
                            const seconds = diff % 60;
                            el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                });
            }, 1000);

            // Update break times and loading bars every 3 seconds for smoother updates
            setInterval(async () => {
                try {
                    // Get active breaks in one call
                    const { data: activeBreaks } = await supabase
                        .from('employee_breaks')
                        .select('*')
                        .is('end_time', null);
                        
                    // Map breaks by email for quick access
                    const breaksByEmail = new Map(activeBreaks.map(break_ => [break_.employee_email, break_]));
                    
                    // Get current employee data
                    const { data: employees } = await supabase
                        .from('requests_users')
                        .select('*')
                        .eq('role', 'back-office');
                        
                    // Update each employee's timers
                    employees.forEach(employee => {
                        const activeBreak = breaksByEmail.get(employee.email);
                        // Use enhanced function with direct DOM manipulation
                        updateBreakProgressBars(employee, activeBreak);
                    });
                } catch (error) {
                    console.error('Error updating timers:', error);
                }
            }, 2000); // Update every 2 seconds for more responsive updates
            
            // Full refresh every 30 seconds but maintain element state
            setInterval(async () => {
                try {
                    // Get current status filter
                    const statusFilter = document.getElementById('employee-status-filter').value;
                    
                    // Get all data in parallel
                    const [employeesResponse, breaksResponse, historyResponse] = await Promise.all([
                        supabase.from('requests_users')
                            .select('*')
                            .eq('role', 'back-office')
                            .order('assignee'),
                        supabase.from('employee_breaks')
                            .select('*')
                            .is('end_time', null),
                        supabase.from('employee_status_history')
                            .select('*')
                            .gte('created_at', new Date().toISOString().split('T')[0])
                    ]);
                    
                    // Process employees data
                    const employees = employeesResponse.data;
                    const breaksByEmail = new Map(breaksResponse.data.map(break_ => [break_.employee_email, break_]));
                    
                    // Update all employees with new data
                    employees.forEach(employee => {
                        const activeBreak = breaksByEmail.get(employee.email);
                        updateBreakProgressBars(employee, activeBreak);
                    });
                    
                    // Update statistics
                    loadStatistics();
                } catch (error) {
                    console.error('Error in full refresh:', error);
                }
            }, 30000);
        }

        // Add a more direct DOM manipulation function for break timers
        function updateBreakProgressBars(employee, activeBreak) {
            if (!employee || !employee.email) return;
            
            const encodedEmail = encodeEmailForSelector(employee.email);
            const now = new Date();
            
            // Get total times to show proper progress even when not on break
            calculateTotalTimeToday(employee.email).then(totals => {
                const coffeeProgressElements = document.querySelectorAll(`.coffee-progress-${encodedEmail}`);
                const coffeeTimeElements = document.querySelectorAll(`.coffee-time-${encodedEmail}`);
                
                // Check if currently on coffee break
                if (employee.status === 'coffee-break' && activeBreak) {
                    const startTime = new Date(activeBreak.start_time);
                    const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 30 - elapsedMinutes);
                    const progress = ((30 - remainingMinutes) / 30) * 100;
                    
                    // Apply changes to all matching elements
                    coffeeProgressElements.forEach(el => {
                        el.style.width = `${Math.min(100, progress)}%`;
                        el.getBoundingClientRect(); // Force reflow
                    });
                    
                    coffeeTimeElements.forEach(el => {
                        el.textContent = `${remainingMinutes}m left`;
                    });
                } else {
                    // Show used coffee time even when not on break
                    const coffeeTimeUsed = totals.totalCoffeeTime;
                    const coffeeTimeLimit = 30; // 30 minutes limit
                    const coffeeProgress = (coffeeTimeUsed / coffeeTimeLimit) * 100;
                    const coffeeRemaining = Math.max(0, coffeeTimeLimit - coffeeTimeUsed);
                    
                    coffeeProgressElements.forEach(el => {
                        el.style.width = `${Math.min(100, coffeeProgress)}%`;
                    });
                    
                    coffeeTimeElements.forEach(el => {
                        el.textContent = `${coffeeRemaining}m left`;
                    });
                }
                
                // Update lunch break progress (similar approach)
                const lunchProgressElements = document.querySelectorAll(`.lunch-progress-${encodedEmail}`);
                const lunchTimeElements = document.querySelectorAll(`.lunch-time-${encodedEmail}`);
                
                if (employee.status === 'lunch-break' && activeBreak) {
                    const startTime = new Date(activeBreak.start_time);
                    const elapsedMinutes = Math.floor((now - startTime) / (1000 * 60));
                    const remainingMinutes = Math.max(0, 40 - elapsedMinutes);
                    const progress = ((40 - remainingMinutes) / 40) * 100;
                    
                    lunchProgressElements.forEach(el => {
                        el.style.width = `${Math.min(100, progress)}%`;
                        el.getBoundingClientRect(); // Force reflow
                    });
                    
                    lunchTimeElements.forEach(el => {
                        el.textContent = `${remainingMinutes}m left`;
                    });
                } else {
                    // Show used lunch time even when not on break
                    const lunchTimeUsed = totals.totalLunchTime;
                    const lunchTimeLimit = 40; // 40 minutes limit
                    const lunchProgress = (lunchTimeUsed / lunchTimeLimit) * 100;
                    const lunchRemaining = Math.max(0, lunchTimeLimit - lunchTimeUsed);
                    
                    lunchProgressElements.forEach(el => {
                        el.style.width = `${Math.min(100, lunchProgress)}%`;
                    });
                    
                    lunchTimeElements.forEach(el => {
                        el.textContent = `${lunchRemaining}m left`;
                    });
                }
                
                // Also update login time progress
                updateLoginTimeProgress(employee);
            }).catch(error => {
                console.error('Error updating break progress bars:', error);
            });
        }

        // Add a separate function to update login time progress
        function updateLoginTimeProgress(employee) {
            if (!employee || !employee.email) return;
            
            const encodedEmail = encodeEmailForSelector(employee.email);
            
            calculateTotalTimeToday(employee.email).then(totals => {
                const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours
                const progress = (totals.totalLoginTime / targetLoginMinutes) * 100;
                const remainingLoginMinutes = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
                
                // Update all login progress bar elements
                document.querySelectorAll(`.login-progress-${encodedEmail}`).forEach(el => {
                    el.style.width = `${Math.min(100, progress)}%`;
                });
                
                // Update all login time elements with consistent format
                document.querySelectorAll(`.login-time-${encodedEmail}`).forEach(el => {
                    const hours = Math.floor(remainingLoginMinutes / 60);
                    const minutes = remainingLoginMinutes % 60;
                    // Use consistent format "Xh XXm left" instead of "X:XXh left"
                    el.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
                });
                
                // Update stats displays
                document.querySelectorAll(`.ready-time-${encodedEmail}`).forEach(el => {
                    el.textContent = formatDurationShort(totals.totalReadyTime);
                });
                
                document.querySelectorAll(`.coffee-total-${encodedEmail}`).forEach(el => {
                    el.textContent = formatDurationShort(totals.totalCoffeeTime);
                });
                
                document.querySelectorAll(`.lunch-total-${encodedEmail}`).forEach(el => {
                    el.textContent = formatDurationShort(totals.totalLunchTime);
                });
            }).catch(error => {
                console.error('Error updating login time progress:', error);
            });
        }

        // Helper function to decode email selector
        function decodeEmailForSelector(encodedEmail) {
            return encodedEmail.replace(/_/g, (match, offset) => {
                if (offset === encodedEmail.indexOf('_')) return '@';
                return '.';
            });
        }

        // Add this new function to update just the time in status
        function updateTimeInStatus(employee) {
            const encodedEmail = encodeEmailForSelector(employee.email);
            const statusDuration = document.querySelector(`#status-duration-${encodedEmail}`);
            
            if (statusDuration) {
                const startTime = new Date(employee.updated_at);
                const now = new Date();
                const duration = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(duration / 3600);
                const minutes = Math.floor((duration % 3600) / 60);
                const seconds = duration % 60;
                statusDuration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Update login time progress
            calculateTotalTimeToday(employee.email).then(totals => {
                const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours in minutes
                const progress = (totals.totalLoginTime / targetLoginMinutes) * 100;
                const remainingMinutes = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
                
                const loginProgressBar = document.querySelector(`.login-progress-${encodedEmail}`);
                const loginTimeDisplay = document.querySelector(`.login-time-${encodedEmail}`);
                
                if (loginProgressBar) {
                    loginProgressBar.style.width = `${Math.min(100, progress)}%`;
                }
                if (loginTimeDisplay) {
                    const hours = Math.floor(remainingMinutes / 60);
                    const minutes = remainingMinutes % 60;
                    // Use consistent format "Xh XXm left"
                    loginTimeDisplay.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m left`;
                }
            });
        }

        // Add this function to sort employees based on the selected criteria
        function sortEmployees(employees, sortOrder) {
            if (sortOrder === 'break') {
                return employees.sort((a, b) => {
                    const statusOrder = {
                        'lunch-break': 1,
                        'coffee-break': 2,
                        'ready': 3,
                        'offline': 4
                    };
                    return statusOrder[a.status] - statusOrder[b.status] || a.assignee.localeCompare(b.assignee);
                });
            } else if (sortOrder === 'ready') {
                return employees.sort((a, b) => {
                    const statusOrder = {
                        'ready': 1,
                        'lunch-break': 2,
                        'coffee-break': 3,
                        'offline': 4
                    };
                    return statusOrder[a.status] - statusOrder[b.status] || a.assignee.localeCompare(b.assignee);
                });
            } else if (sortOrder === 'alpha') {
                return employees.sort((a, b) => a.assignee.localeCompare(b.assignee));
            }
            return employees;
        }

        // Add an event listener for the sort order dropdown
        document.addEventListener('DOMContentLoaded', () => {
            // Existing initialization code...
            
            // Add sort order change event
            document.getElementById('employee-sort-order').addEventListener('change', loadEmployees);
        });

        // Add these helper functions after the loadEmployees function
        function createEmployeeCardHTML(employee, encodedEmail, totals) {
            // Calculate remaining times
            const coffeeTimeLimit = 30;
            const lunchTimeLimit = 40;
            const coffeeRemaining = Math.max(0, coffeeTimeLimit - totals.totalCoffeeTime);
            const lunchRemaining = Math.max(0, lunchTimeLimit - totals.totalLunchTime);
            
            // Calculate login time remaining
            const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours
            const loginRemaining = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
            const loginHours = Math.floor(loginRemaining / 60);
            const loginMinutes = loginRemaining % 60;
            
            return `
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${employee.assignee}</h3>
                        <p class="text-sm text-gray-500">${employee.email}</p>
                    </div>
                    <div class="status-dropdown">
                        <span class="status-indicator status-${employee.status} cursor-pointer" onclick="toggleStatusDropdown(this)">
                            <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                            ${formatStatus(employee.status)}
                        </span>
                        <div class="status-dropdown-content">
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'ready')">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Ready
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'coffee-break')">
                                <i class="fas fa-coffee text-orange-500"></i>
                                Coffee Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'lunch-break')">
                                <i class="fas fa-utensils text-red-500"></i>
                                Lunch Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'offline')">
                                <i class="fas fa-power-off text-gray-500"></i>
                                Offline
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Coffee Break (30 min limit)</span>
                            <span class="coffee-time-${encodedEmail}">${coffeeRemaining}m left</span>
                        </div>
                        <div class="break-timer">
                            <div class="coffee-progress-${encodedEmail} h-full" style="width: ${Math.min(100, (totals.totalCoffeeTime/coffeeTimeLimit)*100)}%;"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Used: ${formatDurationShort(totals.totalCoffeeTime)} of 30m</p>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Lunch Break (40 min limit)</span>
                            <span class="lunch-time-${encodedEmail}">${lunchRemaining}m left</span>
                        </div>
                        <div class="break-timer">
                            <div class="lunch-progress-${encodedEmail} h-full" style="width: ${Math.min(100, (totals.totalLunchTime/lunchTimeLimit)*100)}%;"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Used: ${formatDurationShort(totals.totalLunchTime)} of 40m</p>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Login Time (8:30h target)</span>
                            <span class="login-time-${encodedEmail}">${loginHours}h ${loginMinutes.toString().padStart(2, '0')}m left</span>
                        </div>
                        <div class="break-timer">
                            <div class="login-progress-${encodedEmail} h-full" style="width: ${Math.min(100, (totals.totalLoginTime/(8*60+30))*100)}%;"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Ready Time</p>
                            <p class="text-xl font-semibold ready-time-${encodedEmail}">${formatDurationShort(totals.totalReadyTime)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Break Time</p>
                            <p class="text-xl font-semibold">
                                <span class="coffee-total-${encodedEmail}">${formatDurationShort(totals.totalCoffeeTime)}</span> / 
                                <span class="lunch-total-${encodedEmail}">${formatDurationShort(totals.totalLunchTime)}</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="showStatusHistory('${employee.email}')" class="btn btn-secondary">
                        <i class="fas fa-history mr-2"></i>
                        Status History
                    </button>
                    <button onclick="resetEmployeeBreaks('${employee.email}')" class="btn btn-danger">
                        <i class="fas fa-redo-alt mr-2"></i>
                        Reset Breaks
                    </button>
                </div>
            `;
        }

        function createEmployeeRowHTML(employee, encodedEmail, totals) {
            // Calculate remaining times for hidden elements
            const coffeeTimeLimit = 30;
            const lunchTimeLimit = 40;
            const coffeeRemaining = Math.max(0, coffeeTimeLimit - totals.totalCoffeeTime);
            const lunchRemaining = Math.max(0, lunchTimeLimit - totals.totalLunchTime);
            
            // Calculate login time remaining
            const targetLoginMinutes = 8 * 60 + 30; // 8:30 hours
            const loginRemaining = Math.max(0, targetLoginMinutes - totals.totalLoginTime);
            const loginHours = Math.floor(loginRemaining / 60);
            const loginMinutes = loginRemaining % 60;
            
            return `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="font-medium text-gray-900 truncate max-w-[180px]" title="${employee.assignee}">${employee.assignee}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="status-dropdown relative">
                        <span class="status-indicator status-${employee.status} cursor-pointer inline-flex items-center px-4 py-2" onclick="toggleStatusDropdown(this)">
                            <i class="fas fa-${getStatusIcon(employee.status)} mr-2"></i>
                            ${formatStatus(employee.status)}
                        </span>
                        <div class="status-dropdown-content">
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'ready')">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Ready
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'coffee-break')">
                                <i class="fas fa-coffee text-orange-500"></i>
                                Coffee Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'lunch-break')">
                                <i class="fas fa-utensils text-red-500"></i>
                                Lunch Break
                            </div>
                            <div class="status-option" onclick="changeEmployeeStatus('${employee.email}', 'offline')">
                                <i class="fas fa-power-off text-gray-500"></i>
                                Offline
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-coffee text-orange-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden break-timer">
                                <div class="coffee-progress-${encodedEmail} h-full" style="width: ${Math.min(100, (totals.totalCoffeeTime/coffeeTimeLimit)*100)}%;"></div>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${totals.totalCoffeeTime}/30m</span>
                            <span class="hidden coffee-time-${encodedEmail}">${coffeeRemaining}m left</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-utensils text-red-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden break-timer">
                                <div class="lunch-progress-${encodedEmail} h-full" style="width: ${Math.min(100, (totals.totalLunchTime/lunchTimeLimit)*100)}%;"></div>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${totals.totalLunchTime}/40m</span>
                            <span class="hidden lunch-time-${encodedEmail}">${lunchRemaining}m left</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-clock text-blue-500 w-4"></i>
                            <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden break-timer">
                                <div class="login-progress-${encodedEmail} h-full" style="width: ${Math.min(100, (totals.totalLoginTime/(8*60+30))*100)}%;"></div>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${totals.totalLoginTime}/${8*60+30}m</span>
                            <span class="hidden login-time-${encodedEmail}">${loginHours}h ${loginMinutes.toString().padStart(2, '0')}m left</span>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div id="status-duration-${encodedEmail}" class="text-sm font-medium text-gray-900">00:00:00</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500 w-4"></i>
                            <span class="text-sm text-gray-600">Ready: <span class="font-medium ready-time-${encodedEmail}">${formatDurationShort(totals.totalReadyTime)}</span></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-coffee text-orange-500 w-4"></i>
                            <span class="text-sm text-gray-600">Coffee: <span class="font-medium coffee-total-${encodedEmail}">${formatDurationShort(totals.totalCoffeeTime)}</span></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-utensils text-red-500 w-4"></i>
                            <span class="text-sm text-gray-600">Lunch: <span class="font-medium lunch-total-${encodedEmail}">${formatDurationShort(totals.totalLunchTime)}</span></span>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <div class="flex items-center justify-end space-x-2">
                        <button onclick="showStatusHistory('${employee.email}')" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors duration-200" title="Status History">
                            <i class="fas fa-history"></i>
                        </button>
                        <button onclick="resetEmployeeBreaks('${employee.email}')" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-100 transition-colors duration-200" title="Reset Breaks">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                </td>
            `;
        }

        // Add the missing startStatusTimer function after updateBreakProgressBars
        function startStatusTimer(employee) {
            const encodedEmail = encodeEmailForSelector(employee.email);
            const startTime = new Date(employee.updated_at);
            
            // Update immediately
            updateStatusTimerDisplay(encodedEmail, startTime);
            
            // Then update every second
            const timerId = setInterval(() => {
                updateStatusTimerDisplay(encodedEmail, startTime);
            }, 1000);
            
            // Store timer ID to clean up later if needed
            if (!window.statusTimers) window.statusTimers = {};
            if (window.statusTimers[encodedEmail]) {
                clearInterval(window.statusTimers[encodedEmail]);
            }
            window.statusTimers[encodedEmail] = timerId;
        }

        // Function to update status timer display
        function updateStatusTimerDisplay(encodedEmail, startTime) {
            const statusDurationElements = document.querySelectorAll(`#status-duration-${encodedEmail}`);
            if (!statusDurationElements.length) return;
            
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            
            statusDurationElements.forEach(el => {
                el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            });
        }

        // Helper functions for ticket handling
        function isOverdue(ticket) {
            if (!ticket.created_at) return false;
            const created = new Date(ticket.created_at);
            const now = new Date();
            const hours = (now - created) / (1000 * 60 * 60);
            return hours > 24; // Ticket is overdue if older than 24 hours
        }

        function isApproachingSLA(ticket) {
            if (!ticket.created_at) return false;
            const created = new Date(ticket.created_at);
            const now = new Date();
            const hours = (now - created) / (1000 * 60 * 60);
            return hours > 20 && hours <= 24; // Warning if between 20-24 hours
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDuration(dateString) {
            if (!dateString) return 'N/A';
            const start = new Date(dateString);
            const now = new Date();
            const hours = Math.floor((now - start) / (1000 * 60 * 60));
            const minutes = Math.floor(((now - start) % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }

        // Function to start working on a ticket
        async function startWorkingOnTicket(ticketId) {
            try {
                const { error } = await supabase
                    .from('tickets')
                    .update({ 
                        status: 'in-progress',
                        assigned_to: currentUser.email,
                        updated_at: new Date().toISOString()
                    })
                    .eq('ticket_id', ticketId);

                if (error) throw error;

                await loadTickets();
                showNotification('Started working on ticket #' + ticketId, 'success');
            } catch (error) {
                console.error('Error starting work on ticket:', error);
                showNotification('Failed to start working on ticket', 'error');
            }
        }

        // Add event listeners for search and pagination
    </script>
</body>
</html> 
